<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Snake Ultimate</title>

<style>
:root {
  --bg: linear-gradient(135deg, #1d2671, #c33764);
  --panel: rgba(255,255,255,.15);
  --snake: #4ade80;
  --food: #f87171;
  --text: #fff;
}

* { box-sizing: border-box; font-family: system-ui, sans-serif; }

body {
  margin: 0;
  min-height: 100vh;
  background: var(--bg);
  display: flex;
  justify-content: center;
  align-items: center;
  color: var(--text);
}

.container {
  width: min(95vw, 420px);
  background: var(--panel);
  backdrop-filter: blur(14px);
  border-radius: 20px;
  padding: 16px;
  position: relative;
  text-align: center;
}

header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
}

.stats span { margin: 0 6px; }

canvas {
  width: 100%;
  aspect-ratio: 1;
  background: rgba(0,0,0,.35);
  border-radius: 12px;
}

.overlay {
  position: absolute;
  inset: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10;
}

.overlay-bg {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,.75);
  backdrop-filter: blur(8px);
  border-radius: 20px;
}

.overlay-content {
  position: relative;
  text-align: center;
  animation: pop .4s ease;
}

@keyframes pop {
  from { opacity: 0; transform: scale(.6); }
  to { opacity: 1; transform: scale(1); }
}

.start-btn {
  font-size: 1.5rem;
  padding: 12px 32px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  background: #4ade80;
  color: #fff;
  animation: pulse 1s infinite;
}

@keyframes pulse {
  50% { transform: scale(1.1); }
}
</style>
</head>

<body>
<div class="container">

<header>
  <div class="stats">
    Score: <span id="score">0</span>
    Level: <span id="level">1</span>
    High: <span id="high">0</span>
  </div>
</header>

<canvas id="game" width="400" height="400"></canvas>

<!-- START / GAME OVER -->
<div id="overlay" class="overlay">
  <div class="overlay-bg"></div>
  <div class="overlay-content">
    <h1>üêç Snake</h1>
    <p id="finalText"></p>
    <button class="start-btn">Start</button>
  </div>
</div>

</div>

<audio id="eat" src="sound/eat.mp3"></audio>
<audio id="lose" src="sound/lose.mp3"></audio>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const scoreEl = document.getElementById("score");
const levelEl = document.getElementById("level");
const highEl = document.getElementById("high");
const overlay = document.getElementById("overlay");
const finalText = document.getElementById("finalText");

const eatSound = document.getElementById("eat");
const loseSound = document.getElementById("lose");

const grid = 20;
const tiles = canvas.width / grid;

let snake, dir, food, powerUps;
let score, level, speed;
let activePower = null;
let powerTimer = null;
let paused = true;

let lastTime = 0;
let acc = 0;

const highScore = +localStorage.getItem("snakeHigh") || 0;
highEl.textContent = highScore;

/* ---------- HELPERS ---------- */
const rand = () => Math.floor(Math.random() * tiles);
const vibrate = ms => navigator.vibrate && navigator.vibrate(ms);

/* ---------- START ---------- */
function startGame() {
  snake = [{x:10,y:10,px:10,py:10}];
  dir = {x:1,y:0};
  food = spawnFood();
  powerUps = [];
  activePower = null;

  score = 0;
  level = 1;
  speed = 140;

  scoreEl.textContent = score;
  levelEl.textContent = level;

  lastTime = 0;
  acc = 0;
  paused = false;

  overlay.style.display = "none";
  requestAnimationFrame(loop);
}

/* ---------- GAME OVER ---------- */
function gameOver() {
  paused = true;
  loseSound.play();
  vibrate(300);

  if (score > highScore) {
    localStorage.setItem("snakeHigh", score);
    highEl.textContent = score;
  }

  finalText.textContent = `Score: ${score}`;
  overlay.style.display = "flex";
}

/* ---------- SPAWN ---------- */
function spawnFood() {
  return { x: rand(), y: rand() };
}

function spawnPowerUp() {
  const types = ["speed","shield","double"];
  powerUps.push({
    x: rand(),
    y: rand(),
    type: types[Math.floor(Math.random()*3)]
  });
}

/* ---------- UPDATE ---------- */
function update() {
  const head = snake[0];
  const nx = head.x + dir.x;
  const ny = head.y + dir.y;

  const hitSelf = snake.some(s => s.x===nx && s.y===ny);

  if (
    nx<0 || ny<0 || nx>=tiles || ny>=tiles ||
    (hitSelf && activePower!=="shield")
  ) {
    gameOver();
    return;
  }

  snake.forEach(s=>{s.px=s.x;s.py=s.y});
  snake.unshift({x:nx,y:ny,px:head.x,py:head.y});

  if (nx===food.x && ny===food.y) {
    eatSound.play();
    vibrate(50);

    score += activePower==="double"?2:1;
    scoreEl.textContent = score;

    if (score % 5 === 0) {
      level++;
      levelEl.textContent = level;
      speed = Math.max(60, speed-10);
    }

    if (Math.random()<0.3) spawnPowerUp();
    food = spawnFood();
  } else {
    snake.pop();
  }

  powerUps.forEach((p,i)=>{
    if (p.x===nx && p.y===ny) {
      vibrate(100);
      activePower = p.type;
      clearTimeout(powerTimer);
      powerTimer = setTimeout(()=>activePower=null,5000);
      powerUps.splice(i,1);
    }
  });
}

/* ---------- DRAW ---------- */
function draw(alpha) {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.fillStyle="#f87171";
  ctx.fillRect(food.x*grid,food.y*grid,grid,grid);

  powerUps.forEach(p=>{
    ctx.fillStyle =
      p.type==="speed"?"#60a5fa":
      p.type==="shield"?"#facc15":"#a78bfa";
    ctx.fillRect(p.x*grid+4,p.y*grid+4,grid-8,grid-8);
  });

  ctx.fillStyle = activePower==="shield"?"#fde047":"#4ade80";
  snake.forEach(s=>{
    const x=(s.px+(s.x-s.px)*alpha)*grid;
    const y=(s.py+(s.y-s.py)*alpha)*grid;
    ctx.fillRect(x,y,grid,grid);
  });
}

/* ---------- LOOP ---------- */
function loop(t) {
  if (paused) return;

  if (!lastTime) lastTime=t;
  acc += t-lastTime;
  lastTime=t;

  while(acc>=speed){
    update();
    acc-=speed;
  }

  draw(acc/speed);
  requestAnimationFrame(loop);
}

/* ---------- INPUT ---------- */
document.addEventListener("keydown",e=>{
  if (paused) startGame();
  if (e.key==="ArrowUp" && dir.y!==1) dir={x:0,y:-1};
  if (e.key==="ArrowDown" && dir.y!==-1) dir={x:0,y:1};
  if (e.key==="ArrowLeft" && dir.x!==1) dir={x:-1,y:0};
  if (e.key==="ArrowRight" && dir.x!==-1) dir={x:1,y:0};
});

/* ---------- MOBILE SWIPE (FIXED) ---------- */
let sx=0, sy=0;

canvas.addEventListener("touchstart",e=>{
  const t=e.touches[0];
  sx=t.clientX; sy=t.clientY;
},{passive:true});

canvas.addEventListener("touchend",e=>{
  const t=e.changedTouches[0];
  const dx=t.clientX-sx;
  const dy=t.clientY-sy;

  if (Math.abs(dx)>Math.abs(dy)) {
    if (dx>30 && dir.x!==-1) dir={x:1,y:0};
    else if (dx<-30 && dir.x!==1) dir={x:-1,y:0};
  } else {
    if (dy>30 && dir.y!==-1) dir={x:0,y:1};
    else if (dy<-30 && dir.y!==1) dir={x:0,y:-1};
  }
},{passive:true});

document.querySelector(".start-btn").onclick = startGame;
</script>
</body>
</html>
